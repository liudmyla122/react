{
    "sourceFile": "routes/auth.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765186170885,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765186170885,
            "name": "Commit-0",
            "content": "import { Router } from 'express'\nimport { User } from '../models/user.js'\nimport { hashPassword, comparePassword, signToken } from '../utils/auth.js'\nimport {\n  authRequired,\n  checkMustChangePassword,\n} from '../middlewares/authMiddleware.js'\n\nconst router = Router()\n\nrouter.post('/register', async (req, res) => {\n  try {\n    const { email, password } = req.body\n    if (!email || !password)\n      return res.status(400).json({ error: 'email and password required' })\n\n    const existing = await User.findOne({ where: { email } })\n    if (existing)\n      return res.status(409).json({ error: 'Email already registered' })\n\n    const passwordHash = await hashPassword(password)\n    const user = await User.create({ email, passwordHash })\n    return res.status(201).json({ id: user.id, email: user.email })\n  } catch (err) {\n    return res\n      .status(500)\n      .json({ error: 'Server error', details: (err as Error).message })\n  }\n})\n\nrouter.post('/login', async (req, res) => {\n  try {\n    const { email, password } = req.body\n    if (!email || !password)\n      return res.status(400).json({ error: 'email and password required' })\n    \n    const user = await User.findOne({ where: { email } })\n    if (!user) return res.status(401).json({ error: 'Invalid credentials' })\n\n   \n    const passwordHash = user.getDataValue('passwordHash')\n    const userId = user.getDataValue('id')\n    const userRole = user.getDataValue('role')\n    const userEmail = user.getDataValue('email')\n    const mustChangePassword = user.getDataValue('mustChangePassword')\n\n    if (!passwordHash) {\n      return res.status(500).json({ error: 'User data corrupted' })\n    }\n\n    const ok = await comparePassword(password, passwordHash)\n    if (!ok) return res.status(401).json({ error: 'Invalid credentials' })\n\n   \n    const userForToken = {\n      id: userId,\n      role: userRole,\n      email: userEmail,\n    } as User\n    \n    const token = signToken(userForToken)\n\n    return res.json({ token, mustChangePassword: mustChangePassword || false })\n  } catch (err) {\n    console.error('Login error:', err)\n    const errorMessage = err instanceof Error ? err.message : 'Unknown error'\n    return res\n      .status(500)\n      .json({ error: 'Server error', details: errorMessage })\n  }\n})\n\nrouter.post('/change-password', authRequired, async (req, res) => {\n  try {\n    const user = req.user as User\n    const { newPassword } = req.body\n    if (!newPassword)\n      return res.status(400).json({ error: 'newPassword required' })\n\n    const newHash = await hashPassword(newPassword)\n    user.passwordHash = newHash\n    user.mustChangePassword = false\n    await user.save()\n    return res.json({ message: 'Password changed' })\n  } catch (err) {\n    return res.status(500).json({ error: 'Server error' })\n  }\n})\n\nrouter.post('/delete-account', authRequired, async (req, res) => {\n  try {\n    const user = req.user as User\n    const { password } = req.body\n    if (!password) return res.status(400).json({ error: 'password required' })\n\n    const ok = await comparePassword(password, user.passwordHash)\n    if (!ok) return res.status(401).json({ error: 'Incorrect password' })\n\n    await user.destroy()\n    return res.json({ message: 'Account deleted' })\n  } catch (err) {\n    return res.status(500).json({ error: 'Server error' })\n  }\n})\n\nrouter.post('/change-email', authRequired, async (req, res) => {\n  try {\n    const user = req.user as User\n    const { newEmail, password } = req.body\n    if (!newEmail || !password)\n      return res.status(400).json({ error: 'newEmail and password required' })\n\n    const ok = await comparePassword(password, user.passwordHash)\n    if (!ok) return res.status(401).json({ error: 'Incorrect password' })\n\n    const existing = await User.findOne({ where: { email: newEmail } })\n    if (existing)\n      return res.status(409).json({ error: 'Email already registered' })\n\n    user.email = newEmail\n    await user.save()\n    return res.json({ message: 'Email updated', email: user.email })\n  } catch (err) {\n    return res.status(500).json({ error: 'Server error' })\n  }\n})\n\nexport default router\n"
        }
    ]
}